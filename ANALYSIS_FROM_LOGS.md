# Анализ проблемы на основе логов

## Ключевые данные из логов:

### 1. Входные данные автопилота:
- `localHorizontalDelta.z = -0.81` (цель сзади) ✓
- `desiredVelocityLocal.y = -0.24` (назад, локальный Z) ✓
- `correctionZ = -0.089` (назад) ✓
- `movementDirection.y = -0.089` (назад) ✓

### 2. Поворот двигателей:
- `desiredMovementDirection.y = -0.089` (назад) ✓
- `targetAngleX = +4.0°` (наклон вперед) ✓
- `targetAngleY = -33.5°` (поворот влево) ✓

### 3. Направление двигателя после поворота:
- `engineForwardLocal = (-0.18, -0.98, -0.04)`
  - X = -0.18 (влево)
  - **Y = -0.98 (вниз!)** ⚠️
  - Z = -0.04 (немного назад)

## ПРОБЛЕМА НАЙДЕНА!

**Двигатель изначально направлен ВНИЗ (Y = -0.98)!**

Это означает:
1. Двигатель создан для создания тяги ВВЕРХ (против гравитации)
2. Когда мы наклоняем его вперед на 4°, его `forward` все еще направлен в основном ВНИЗ
3. Горизонтальная компонента (Z) очень мала (-0.04)

## Логика применения силы:

```csharp
Vector3 engineDirection = -engineForward;
// Если engineForward = (-0.18, -0.98, -0.04)
// То engineDirection = (0.18, 0.98, 0.04)
```

**Сила направлена:**
- X = 0.18 (вправо) ✓
- Y = 0.98 (вверх) ✓ - это правильно для компенсации гравитации
- Z = 0.04 (вперед) ⚠️ **ПРОБЛЕМА!**

**Мы хотим силу назад (Z < 0), но получаем силу вперед (Z > 0)!**

## Почему это происходит?

Когда двигатель направлен вниз и мы наклоняем его вперед:
- `targetAngleX = +4.0°` (наклон вперед)
- Но двигатель изначально направлен вниз
- После наклона его `forward` все еще в основном вниз, но немного вперед
- `engineForward.z` становится положительным (вперед)
- `engineDirection.z = -engineForward.z` становится отрицательным (назад) ✓

**НО:** В логах `engineForwardLocal.z = -0.04` (назад), что правильно!

**Значит проблема не в направлении `forward`!**

## Возможные причины:

1. **Сила слишком мала:** Z = 0.04 очень маленькая, может быть недостаточно для движения назад
2. **Вертикальная сила доминирует:** Y = 0.98 намного больше, чем Z = 0.04
3. **Проблема в применении силы:** Может быть, сила применяется неправильно?

## Что нужно проверить:

1. **Логи применения силы:** Нужны логи из `ApplyThrustFromEngines()` с `totalForce` (локальные координаты)
2. **Проверить, правильно ли применяется сила:** Может быть, нужно использовать `AddForceAtPosition` вместо `AddForce`?
3. **Проверить, правильно ли вычисляется `engineDirection`:** Может быть, нужно изменить знак?

## ВОЗМОЖНОЕ РЕШЕНИЕ:

Если двигатель изначально направлен вниз, то:
- Когда мы хотим двигаться назад (`desiredMovementDirection.y < 0`), нужно наклонять двигатель НАЗАД, а не вперед!
- `targetAngleX = -desiredMovementDirection.y * maxTiltAngle` должно давать отрицательный угол (наклон назад), когда `desiredMovementDirection.y < 0`

**НО:** В коде `targetAngleX = -desiredMovementDirection.y * maxTiltAngle`
- Если `desiredMovementDirection.y = -0.089` (назад)
- То `targetAngleX = -(-0.089) * maxTiltAngle = +4.0°` (наклон вперед)

**Это правильно для двигателя, который изначально направлен ВВЕРХ!**

**НО для двигателя, который изначально направлен ВНИЗ, нужно ИЗМЕНИТЬ ЗНАК!**

## РЕШЕНИЕ:

Нужно проверить начальное направление двигателей и изменить знак в `UpdateEngineRotationsFromMovementDirection`:

```csharp
// Если двигатель изначально направлен ВНИЗ (для создания тяги вверх):
// Когда desiredMovementDirection.y < 0 (назад), нужно наклонять НАЗАД (отрицательный угол)
targetAngleX = desiredMovementDirection.y * maxTiltAngle; // Убрать минус!
```

Или проверить начальное направление и использовать правильный знак в зависимости от ориентации.
